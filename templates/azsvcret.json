{
  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
  "contentVersion": "1.0.0.6",
  "parameters": {
    "kqlquery_alert_name_prefix": {
      "type": "String",
      "defaultValue": "arule-sretirement-",
      "metadata": {
        "description": "Prefix used for the Scheduled Query Rule name. The subscription display name and subscription ID will be appended automatically."
      }
    },
    "actiongroups_externalid": {
      "type": "String",
      "defaultValue": "",
      "metadata": {
        "description": "Full Resource ID of the Action Group to be invoked when the alert fires."
      }
    },
    "alert_location": {
      "type": "String",
      "defaultValue": "westeurope",
      "metadata": {
        "description": "Azure region where the Scheduled Query Rule resource will be deployed."
      }
    }
  },
  "variables": {},
  "resources": [
    {
      "type": "microsoft.insights/scheduledqueryrules",
      "apiVersion": "2025-01-01-preview",
      "name": "[substring(concat(parameters('kqlquery_alert_name_prefix'), subscription().displayName, '-', subscription().subscriptionId), 0, min(length(concat(parameters('kqlquery_alert_name_prefix'), subscription().displayName, '-', subscription().subscriptionId)), 260))]",
      "location": "[parameters('alert_location')]",
      "kind": "LogAlert",
      "identity": {
        "type": "SystemAssigned"
      },
      "properties": {
        "displayName": "[concat(parameters('kqlquery_alert_name_prefix'), subscription().displayName, '-', subscription().subscriptionId)]",
        "description": "Azure Service Retirements due date soon which needs your review and planning for remediation",
        "severity": 2,
        "enabled": true,
        "evaluationFrequency": "P1D",
        "scopes": [
          "[subscription().id]"
        ],
        "windowSize": "P1D",
        "criteria": {
          "allOf": [
            {
              "query": "arg(\"\").advisorresources | where type == \"microsoft.advisor/recommendations\" | where properties.extendedProperties.recommendationSubCategory == \"ServiceUpgradeAndRetirement\" | extend RetirementFeature = tostring(properties.extendedProperties.retirementFeatureName), RetirementDate = todatetime(properties.extendedProperties.retirementDate), Impact = tostring(properties.impact), ResourceId = tostring(properties.resourceMetadata.resourceId), ResourceType = tostring(properties.impactedField), Problem = tostring(properties.shortDescription.problem), Solution = tostring(properties.shortDescription.solution), LastUpdated = todatetime(properties.lastUpdated) | extend ResourceName = iff(isempty(ResourceId), \"Platform-wide\", tostring(split(ResourceId, \"/\")[-1])) | where isnotempty(RetirementFeature) | where RetirementDate between (now()-730d .. now()+180d) | order by RetirementDate asc | summarize RetiredResources = make_list(pack(\"SubscriptionId\", subscriptionId, \"ResourceName\", ResourceName, \"ResourceType\", ResourceType, \"RetirementFeature\", RetirementFeature, \"RetirementDate\", RetirementDate, \"Impact\", Impact, \"Problem\", Problem, \"Solution\", Solution, \"ResourceId\", ResourceId, \"LastUpdated\", LastUpdated)), RetiredCount = count() | where RetiredCount > 0",
              "timeAggregation": "Count",
              "operator": "GreaterThan",
              "threshold": 0,
              "resourceIdColumn": "ResourceId",
              "dimensions": [],
              "failingPeriods": {
                "numberOfEvaluationPeriods": 1,
                "minFailingPeriodsToAlert": 1
              }
            }
          ]
        },
        "autoMitigate": false,
        "actions": {
          "actionGroups": [
            "[parameters('actiongroups_externalid')]"
          ],
          "customProperties": {},
          "actionProperties": {
            "Email.Subject": "Azure Service Retirements due date soon for your review and planning"
          }
        }
      }
    }
  ]
}
