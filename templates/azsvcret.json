{
  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
  "contentVersion": "1.0.0.6",
  "parameters": {
    "kqlquery_alert_name_prefix": {
      "type": "String",
      "defaultValue": "arule-sretirement-",
      "metadata": {
        "description": "Prefix used for the Scheduled Query Rule name. The subscription display name and subscription ID will be appended automatically."
      }
    },
    "actiongroups_externalid": {
      "type": "String",
      "defaultValue": "",
      "metadata": {
        "description": "Full Resource ID of the Action Group to be invoked when the alert fires."
      }
    },
    "alert_location": {
      "type": "String",
      "defaultValue": "westeurope",
      "metadata": {
        "description": "Azure region where the Scheduled Query Rule resource will be deployed."
      }
    }
  },
  "variables": {},
  "resources": [
    {
      "type": "microsoft.insights/scheduledqueryrules",
      "apiVersion": "2025-01-01-preview",
      "name": "[substring(concat(parameters('kqlquery_alert_name_prefix'), subscription().displayName, '-', subscription().subscriptionId), 0, min(length(concat(parameters('kqlquery_alert_name_prefix'), subscription().displayName, '-', subscription().subscriptionId)), 260))]",
      "location": "[parameters('alert_location')]",
      "kind": "LogAlert",
      "identity": {
        "type": "SystemAssigned"
      },
      "properties": {
        "displayName": "[concat(parameters('kqlquery_alert_name_prefix'), subscription().displayName, '-', subscription().subscriptionId)]",
        "description": "Azure Service Retirements due date soon which needs your review and planning for remediation",
        "severity": 2,
        "enabled": true,
        "evaluationFrequency": "P1D",
        "scopes": [
          "[subscription().id]"
        ],
        "windowSize": "P1D",
        "criteria": {
          "allOf": [
            {
              "query": "arg(\"\").advisorresources\n| where type == \"microsoft.advisor/recommendations\"\n| extend props = todynamic(properties)\n| where tostring(props.extendedProperties.recommendationSubCategory) == \"ServiceUpgradeAndRetirement\"\n| extend\n    RetirementFeature = tostring(props.extendedProperties.retirementFeatureName),\n    RetirementDate = todatetime(strcat(tostring(props.extendedProperties.retirementDate))),\n    Impact = tostring(props.impact),\n    ResourceId = tostring(props.resourceMetadata.resourceId),\n    ResourceType = tostring(props.impactedField),\n    Problem = tostring(props.shortDescription.problem),\n    Solution = tostring(props.shortDescription.solution),\n    LastUpdated = todatetime(props.lastUpdated)\n| extend\n    ResourceName = iff(\n        isempty(ResourceId),\n        \"Platform-wide\",\n        tostring(split(ResourceId, \"/\")[-1])\n    )\n| where RetirementFeature != \"\"\n| where RetirementDate between (now()-730d .. now()+180d)\n| project subscriptionId, ResourceName, ResourceType, RetirementFeature, RetirementDate, Impact, Problem, Solution, ResourceId, LastUpdated\n| order by RetirementDate asc",
              "timeAggregation": "Count",
              "operator": "GreaterThan",
              "threshold": 0,
              "resourceIdColumn": "ResourceId",
              "dimensions": [],
              "failingPeriods": {
                "numberOfEvaluationPeriods": 1,
                "minFailingPeriodsToAlert": 1
              }
            }
          ]
        },
        "autoMitigate": false,
        "actions": {
          "actionGroups": [
            "[parameters('actiongroups_externalid')]"
          ],
          "customProperties": {},
          "actionProperties": {
            "Email.Subject": "Azure Service Retirements due date soon for your review and planning"
          }
        }
      }
    }
  ]
}
